# Matthew J Carr, Sarah Steeg, Roger T Webb, Nav Kapur, Carolyn A Chew-Graham, Kathryn M Abel, Holly Hope, Matthias Pierce, Darren M. Ashcroft, 2024.

import sys, csv, re

codes = [{"code":"73414","system":"gprdproduct"},{"code":"30258","system":"gprdproduct"},{"code":"56009","system":"gprdproduct"},{"code":"34822","system":"gprdproduct"},{"code":"74588","system":"gprdproduct"},{"code":"59358","system":"gprdproduct"},{"code":"4011","system":"gprdproduct"},{"code":"45329","system":"gprdproduct"},{"code":"65165","system":"gprdproduct"},{"code":"69542","system":"gprdproduct"},{"code":"14740","system":"gprdproduct"},{"code":"75799","system":"gprdproduct"},{"code":"67092","system":"gprdproduct"},{"code":"60619","system":"gprdproduct"},{"code":"33779","system":"gprdproduct"},{"code":"70063","system":"gprdproduct"},{"code":"48220","system":"gprdproduct"},{"code":"7153","system":"gprdproduct"},{"code":"8144","system":"gprdproduct"},{"code":"26016","system":"gprdproduct"},{"code":"13496","system":"gprdproduct"},{"code":"34871","system":"gprdproduct"},{"code":"34356","system":"gprdproduct"},{"code":"4297","system":"gprdproduct"},{"code":"34419","system":"gprdproduct"},{"code":"52354","system":"gprdproduct"},{"code":"77650","system":"gprdproduct"},{"code":"34294","system":"gprdproduct"},{"code":"60962","system":"gprdproduct"},{"code":"33071","system":"gprdproduct"},{"code":"67769","system":"gprdproduct"},{"code":"75688","system":"gprdproduct"},{"code":"6218","system":"gprdproduct"},{"code":"32899","system":"gprdproduct"},{"code":"57532","system":"gprdproduct"},{"code":"67736","system":"gprdproduct"},{"code":"50","system":"gprdproduct"},{"code":"6360","system":"gprdproduct"},{"code":"52607","system":"gprdproduct"},{"code":"66744","system":"gprdproduct"},{"code":"36893","system":"gprdproduct"},{"code":"67758","system":"gprdproduct"},{"code":"69685","system":"gprdproduct"},{"code":"62155","system":"gprdproduct"},{"code":"19470","system":"gprdproduct"},{"code":"71848","system":"gprdproduct"},{"code":"72773","system":"gprdproduct"},{"code":"34849","system":"gprdproduct"},{"code":"69525","system":"gprdproduct"},{"code":"42107","system":"gprdproduct"},{"code":"73589","system":"gprdproduct"},{"code":"34722","system":"gprdproduct"},{"code":"34351","system":"gprdproduct"},{"code":"71852","system":"gprdproduct"},{"code":"75943","system":"gprdproduct"},{"code":"45247","system":"gprdproduct"},{"code":"41062","system":"gprdproduct"},{"code":"73417","system":"gprdproduct"},{"code":"33978","system":"gprdproduct"},{"code":"40726","system":"gprdproduct"},{"code":"37256","system":"gprdproduct"},{"code":"34966","system":"gprdproduct"},{"code":"65771","system":"gprdproduct"},{"code":"71669","system":"gprdproduct"},{"code":"73668","system":"gprdproduct"},{"code":"34288","system":"gprdproduct"},{"code":"67","system":"gprdproduct"},{"code":"252","system":"gprdproduct"},{"code":"72373","system":"gprdproduct"},{"code":"40892","system":"gprdproduct"},{"code":"67564","system":"gprdproduct"},{"code":"418","system":"gprdproduct"},{"code":"58476","system":"gprdproduct"},{"code":"29786","system":"gprdproduct"},{"code":"841","system":"gprdproduct"},{"code":"1712","system":"gprdproduct"},{"code":"48026","system":"gprdproduct"},{"code":"45316","system":"gprdproduct"},{"code":"61335","system":"gprdproduct"},{"code":"19183","system":"gprdproduct"},{"code":"77381","system":"gprdproduct"},{"code":"34970","system":"gprdproduct"},{"code":"4329","system":"gprdproduct"},{"code":"55023","system":"gprdproduct"},{"code":"79506","system":"gprdproduct"},{"code":"34216","system":"gprdproduct"},{"code":"68266","system":"gprdproduct"},{"code":"2548","system":"gprdproduct"},{"code":"34456","system":"gprdproduct"},{"code":"67097","system":"gprdproduct"},{"code":"34202","system":"gprdproduct"},{"code":"38890","system":"gprdproduct"},{"code":"34415","system":"gprdproduct"},{"code":"22","system":"gprdproduct"},{"code":"3601","system":"gprdproduct"},{"code":"63953","system":"gprdproduct"},{"code":"42803","system":"gprdproduct"},{"code":"53394","system":"gprdproduct"},{"code":"33410","system":"gprdproduct"},{"code":"60568","system":"gprdproduct"},{"code":"47363","system":"gprdproduct"},{"code":"45224","system":"gprdproduct"},{"code":"73759","system":"gprdproduct"}];
REQUIRED_CODES = 1;
with open(sys.argv[1], 'r') as file_in, open('antidepressants-potential-cases.csv', 'w', newline='') as file_out:
    csv_reader = csv.DictReader(file_in)
    csv_writer = csv.DictWriter(file_out, csv_reader.fieldnames + ["antidepressants-200mg---primary-identified"])
    csv_writer.writeheader();
    codes_identified = 0;
    for row in csv_reader:
        newRow = row.copy();
        for cell in row:
            # Iterate cell lists (e.g. codes)
            for item in re.findall(r'\(([^,]*)\,', row[cell]):
                if(item in list(map(lambda code: code['code'], codes))): codes_identified+=1;
                if(codes_identified>=REQUIRED_CODES):
                    newRow["antidepressants-200mg---primary-identified"] = "CASE";
                    break;
            if(codes_identified>=REQUIRED_CODES): break;
        if(codes_identified<REQUIRED_CODES):
            newRow["antidepressants-200mg---primary-identified"] = "UNK";
        codes_identified=0;
        csv_writer.writerow(newRow)
