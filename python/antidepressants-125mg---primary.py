# Matthew J Carr, Sarah Steeg, Roger T Webb, Nav Kapur, Carolyn A Chew-Graham, Kathryn M Abel, Holly Hope, Matthias Pierce, Darren M. Ashcroft, 2024.

import sys, csv, re

codes = [{"code":"41729","system":"gprdproduct"},{"code":"8055","system":"gprdproduct"},{"code":"64141","system":"gprdproduct"},{"code":"17087","system":"gprdproduct"},{"code":"48216","system":"gprdproduct"},{"code":"40494","system":"gprdproduct"},{"code":"34223","system":"gprdproduct"},{"code":"6645","system":"gprdproduct"},{"code":"75645","system":"gprdproduct"},{"code":"3926","system":"gprdproduct"},{"code":"1169","system":"gprdproduct"},{"code":"64647","system":"gprdproduct"},{"code":"35122","system":"gprdproduct"},{"code":"54877","system":"gprdproduct"},{"code":"78224","system":"gprdproduct"},{"code":"34503","system":"gprdproduct"},{"code":"34245","system":"gprdproduct"},{"code":"62819","system":"gprdproduct"},{"code":"1809","system":"gprdproduct"},{"code":"785","system":"gprdproduct"},{"code":"60355","system":"gprdproduct"},{"code":"24134","system":"gprdproduct"},{"code":"78057","system":"gprdproduct"},{"code":"34224","system":"gprdproduct"},{"code":"7751","system":"gprdproduct"},{"code":"34782","system":"gprdproduct"},{"code":"84","system":"gprdproduct"},{"code":"18932","system":"gprdproduct"},{"code":"2039","system":"gprdproduct"},{"code":"57226","system":"gprdproduct"},{"code":"30375","system":"gprdproduct"},{"code":"25945","system":"gprdproduct"},{"code":"66652","system":"gprdproduct"},{"code":"8377","system":"gprdproduct"},{"code":"41408","system":"gprdproduct"},{"code":"64458","system":"gprdproduct"},{"code":"33164","system":"gprdproduct"},{"code":"34745","system":"gprdproduct"},{"code":"60410","system":"gprdproduct"},{"code":"24147","system":"gprdproduct"},{"code":"78364","system":"gprdproduct"},{"code":"6894","system":"gprdproduct"},{"code":"32439","system":"gprdproduct"},{"code":"79766","system":"gprdproduct"},{"code":"67127","system":"gprdproduct"},{"code":"8720","system":"gprdproduct"},{"code":"16229","system":"gprdproduct"},{"code":"17319","system":"gprdproduct"},{"code":"40295","system":"gprdproduct"},{"code":"51758","system":"gprdproduct"},{"code":"76927","system":"gprdproduct"},{"code":"23426","system":"gprdproduct"},{"code":"6054","system":"gprdproduct"},{"code":"54081","system":"gprdproduct"},{"code":"45350","system":"gprdproduct"},{"code":"9022","system":"gprdproduct"},{"code":"34641","system":"gprdproduct"},{"code":"65987","system":"gprdproduct"},{"code":"49","system":"gprdproduct"},{"code":"50722","system":"gprdproduct"},{"code":"78278","system":"gprdproduct"},{"code":"66493","system":"gprdproduct"},{"code":"65762","system":"gprdproduct"},{"code":"44853","system":"gprdproduct"},{"code":"31824","system":"gprdproduct"},{"code":"3657","system":"gprdproduct"},{"code":"34197","system":"gprdproduct"},{"code":"18290","system":"gprdproduct"},{"code":"71023","system":"gprdproduct"},{"code":"42078","system":"gprdproduct"},{"code":"41970","system":"gprdproduct"},{"code":"41563","system":"gprdproduct"},{"code":"45737","system":"gprdproduct"},{"code":"67990","system":"gprdproduct"},{"code":"19168","system":"gprdproduct"},{"code":"45226","system":"gprdproduct"},{"code":"76952","system":"gprdproduct"},{"code":"34355","system":"gprdproduct"},{"code":"42394","system":"gprdproduct"},{"code":"35065","system":"gprdproduct"},{"code":"34474","system":"gprdproduct"},{"code":"79276","system":"gprdproduct"},{"code":"70593","system":"gprdproduct"},{"code":"66579","system":"gprdproduct"},{"code":"5298","system":"gprdproduct"},{"code":"34643","system":"gprdproduct"},{"code":"63276","system":"gprdproduct"},{"code":"16949","system":"gprdproduct"},{"code":"40777","system":"gprdproduct"},{"code":"66201","system":"gprdproduct"},{"code":"41971","system":"gprdproduct"},{"code":"34129","system":"gprdproduct"},{"code":"55139","system":"gprdproduct"},{"code":"3554","system":"gprdproduct"},{"code":"3670","system":"gprdproduct"},{"code":"34813","system":"gprdproduct"},{"code":"76317","system":"gprdproduct"},{"code":"66572","system":"gprdproduct"},{"code":"34872","system":"gprdproduct"},{"code":"26513","system":"gprdproduct"},{"code":"42247","system":"gprdproduct"},{"code":"64727","system":"gprdproduct"},{"code":"3903","system":"gprdproduct"},{"code":"71042","system":"gprdproduct"},{"code":"35530","system":"gprdproduct"},{"code":"595","system":"gprdproduct"},{"code":"77167","system":"gprdproduct"},{"code":"29875","system":"gprdproduct"},{"code":"6405","system":"gprdproduct"},{"code":"7981","system":"gprdproduct"},{"code":"70838","system":"gprdproduct"},{"code":"6312","system":"gprdproduct"},{"code":"24145","system":"gprdproduct"},{"code":"7678","system":"gprdproduct"},{"code":"33780","system":"gprdproduct"},{"code":"57978","system":"gprdproduct"},{"code":"487","system":"gprdproduct"},{"code":"7979","system":"gprdproduct"},{"code":"65439","system":"gprdproduct"}];
REQUIRED_CODES = 1;
with open(sys.argv[1], 'r') as file_in, open('antidepressants-potential-cases.csv', 'w', newline='') as file_out:
    csv_reader = csv.DictReader(file_in)
    csv_writer = csv.DictWriter(file_out, csv_reader.fieldnames + ["antidepressants-125mg---primary-identified"])
    csv_writer.writeheader();
    codes_identified = 0;
    for row in csv_reader:
        newRow = row.copy();
        for cell in row:
            # Iterate cell lists (e.g. codes)
            for item in re.findall(r'\(([^,]*)\,', row[cell]):
                if(item in list(map(lambda code: code['code'], codes))): codes_identified+=1;
                if(codes_identified>=REQUIRED_CODES):
                    newRow["antidepressants-125mg---primary-identified"] = "CASE";
                    break;
            if(codes_identified>=REQUIRED_CODES): break;
        if(codes_identified<REQUIRED_CODES):
            newRow["antidepressants-125mg---primary-identified"] = "UNK";
        codes_identified=0;
        csv_writer.writerow(newRow)
